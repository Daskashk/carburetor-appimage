name: Build Carburetor AppImage

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      options: --privileged

    steps:
    - name: Install system dependencies
      run: |
        apt-get update
        apt-get install -y \
          wget \
          desktop-file-utils \
          libfuse2 \
          libgtk-4-1 \
          libadwaita-1-0 \
          libgdk-pixbuf-2.0-0 \
          libgirepository-1.0-1 \
          gir1.2-adw-1 \
          gir1.2-gtk-4.0 \
          libglib2.0-bin \
          python3-pycountry \
          adwaita-icon-theme-full \
          appstream-util

    - name: Download Carburetor and Tractor .deb packages
      run: |
        wget https://framagit.org/-/project/67091/uploads/35726bec322917933fa728781c0ece30/carburetor_5.1.1-1_all.deb -O carburetor.deb
        wget https://framagit.org/-/project/67089/uploads/8cf5030f4d7b4b22ef56295febda5736/tractor_5.1.0-1_all.deb -O tractor.deb

    - name: Extract packages into AppDir
      run: |
        mkdir -p AppDir
        dpkg-deb -x carburetor.deb AppDir
        dpkg-deb -x tractor.deb AppDir

    - name: Prepare AppDir structure
      run: |
        # Mover archivos a ubicaciones estándar de AppImage
        mkdir -p AppDir/usr/bin
        mv AppDir/usr/bin/carburetor AppDir/usr/bin/carburetor.bin
        mv AppDir/usr/bin/tractor AppDir/usr/bin/tractor.bin
        
        # Crear enlace simbólico para el ejecutable principal
        ln -s carburetor.bin AppDir/usr/bin/carburetor
        
        # Mover .desktop e icono
        cp AppDir/usr/share/applications/io.frama.tractor.carburetor.desktop AppDir/
        cp AppDir/usr/share/icons/hicolor/scalable/apps/io.frama.tractor.carburetor.svg AppDir/

    - name: Create AppRun with environment setup
      run: |
        cat << 'EOF' > AppDir/AppRun
        #!/bin/sh
        HERE=$(dirname "$(readlink -f "$0")")
        
        # Configuración esencial para GTK4/libadwaita
        export GTK_THEME=Adwaita-dark
        export GDK_BACKEND=x11
        export XDG_DATA_DIRS="$HERE/usr/share:${XDG_DATA_DIRS:-/usr/share}"
        export GI_TYPELIB_PATH="$HERE/usr/lib/girepository-1.0"
        export LD_LIBRARY_PATH="$HERE/usr/lib:$HERE/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH"
        export PATH="$HERE/usr/bin:$PATH"
        
        # Configurar esquemas GSettings
        export GSETTINGS_SCHEMA_DIR="$HERE/usr/share/glib-2.0/schemas"
        
        # Ejecutar la aplicación
        exec carburetor "$@"
        EOF
        chmod +x AppDir/AppRun

    - name: Bundle critical GTK resources
      run: |
        # Crear directorios necesarios
        mkdir -p AppDir/usr/lib/x86_64-linux-gnu
        mkdir -p AppDir/usr/share/gir-1.0
        mkdir -p AppDir/usr/lib/girepository-1.0
        
        # Copiar librerías esenciales
        cp /usr/lib/x86_64-linux-gnu/libgtk-4.so* AppDir/usr/lib/x86_64-linux-gnu/
        cp /usr/lib/x86_64-linux-gnu/libadwaita-1.so* AppDir/usr/lib/x86_64-linux-gnu/
        cp /usr/lib/x86_64-linux-gnu/libgirepository-1.0.so* AppDir/usr/lib/x86_64-linux-gnu/
        
        # Copiar typelibs
        cp /usr/lib/x86_64-linux-gnu/girepository-1.0/Adw-1.typelib AppDir/usr/lib/girepository-1.0/
        cp /usr/lib/x86_64-linux-gnu/girepository-1.0/Gtk-4.0.typelib AppDir/usr/lib/girepository-1.0/
        
        # Copiar schemas de GLib
        mkdir -p AppDir/usr/share/glib-2.0/schemas
        cp /usr/share/glib-2.0/schemas/*.gschema.xml AppDir/usr/share/glib-2.0/schemas/
        glib-compile-schemas AppDir/usr/share/glib-2.0/schemas
        
        # Copiar recursos de Adwaita
        mkdir -p AppDir/usr/share/adwaita
        cp -r /usr/share/adwaita/* AppDir/usr/share/adwaita/ 2>/dev/null || true
        
        # Copiar recursos de iconos
        mkdir -p AppDir/usr/share/icons
        cp -r /usr/share/icons/Adwaita* AppDir/usr/share/icons/ 2>/dev/null || true
        cp -r /usr/share/icons/hicolor AppDir/usr/share/icons/

    - name: Download appimagetool
      run: |
        wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
        chmod +x appimagetool

    - name: Build AppImage
      run: |
        ARCH=x86_64 ./appimagetool \
          --comp xz \
          AppDir \
          Carburetor-linux-x86_64.AppImage

    - name: Upload AppImage as artifact
      uses: actions/upload-artifact@v4
      with:
        name: Carburetor.AppImage
        path: Carburetor-linux-x86_64.AppImage

    - name: Release AppImage
      uses: softprops/action-gh-release@v1
      with:
        files: Carburetor-linux-x86_64.AppImage
